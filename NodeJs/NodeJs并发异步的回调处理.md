# NodeJs并发异步的回调处理

这里说并发异步，并不准确，应该说连续异步。NodeJs单线程异步的特性，直接导致多个异步同时进行时，无法确定最后的执行结果来回调。举个简单的例子：

```
for(var i = 0; i < 5; i++) {
	fs.readFile('file', 'utf-8', function(error, data){});
}
```

连续发起了5次读文件的异步操作，很简单，那么问题来了，我怎么确定所有异步都执行完了呢？因为要在它们都执行完后，才能进行之后的操作。相信有点经验的同学都会想到使用记数的方式来进行，但如何保证记数正确又是一个问题。仔细想想：

回调是一个函数，每个异步操作时将计数器+1，当每个异步结束时将计数器-1，通过判断计数器是否为0来确定是否执行回调。这个逻辑很简单，需要一个相对于执行时和回调时的全局变量作为计数器，而且要在传给异步方法是执行+1的操作，而且之后将返回一个用来回调的函数，有点绕，不过看看Js函数的高级用法：

```
var pending = (function() {
	var count = 0;
	return function() {
		count++;
		return function() {
			count--;
			if (count === 0) {
				// 全部执行完毕
			}
		}
	}
});
```
